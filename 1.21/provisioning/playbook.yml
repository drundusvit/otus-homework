---
- hosts: all
  sudo: yes
  tasks:
  - name: install packages
    yum: name={{ item }} state=latest 
    with_items:
      - bind
      - bind-utils
      - ntp

- hosts: ns01
  sudo: yes
  tasks:
  - name: copy named.conf
    copy: src=master-named.conf dest=/etc/named.conf owner=root group=named mode=0640
  - name: copy zones
    copy: src={{ item }} dest=/etc/named/ owner=root group=named mode=0660
    with_fileglob:
      - named.d*

  - name: copy newdns zone
    copy: src=named.newdns.lab dest=/etc/named/named.newdns.lab owner=root group=named mode=0660

  - name: Create subfolder
    file:
      path: /etc/named/client1/
      state: directory
      mode: 0670
      owner: root
      group: named

  - name: copy client1 zone
    copy: src=client1.named.dns.lab dest=/etc/named/client1/named.dns.lab owner=root group=named mode=0660

  - name: copy resolv.conf to the servers
    copy: src=servers-resolv.conf dest=/etc/resolv.conf owner=root group=root mode=0644
  
  - name: set /etc/named permissions
    file: path=/etc/named owner=root group=named mode=0670

  - name: Allow to change master zone file
    shell: setsebool -P named_write_master_zones 1

  - name: Make named permissive for SELinux
    shell: semanage permissive -a named_t

  - name: ensure named is running and enabled
    service: name=named state=restarted enabled=yes


- hosts: ns02
  sudo: yes
  tasks:
  - name: copy named.conf
    copy: src=slave-named.conf dest=/etc/named.conf owner=root group=named mode=0640
  - name: copy resolv.conf to the servers
    copy: src=servers-resolv.conf dest=/etc/resolv.conf owner=root group=root mode=0644

  - name: Create subfolder
    file:
      path: /etc/named/client1/
      state: directory
      mode: 0670
      owner: root
      group: named

  - name: set /etc/named permissions
    file: path=/etc/named owner=root group=named mode=0670

  - name: Allow to change master zone file
    shell: setsebool -P named_write_master_zones 1

  - name: Make named permissive for SELinux
    shell: semanage permissive -a named_t

  - name: ensure named is running and enabled
    service: name=named state=restarted enabled=yes

    
- hosts: client1
  sudo: yes
  tasks:
  - name: copy resolv.conf to the client
    copy: src=client-resolv.conf dest=/etc/resolv.conf owner=root group=root mode=0644
  - name: copy rndc conf file
    copy: src=rndc.conf dest=/home/vagrant/rndc.conf owner=vagrant group=vagrant mode=0644
  - name: copy motd to the client
    copy: src=client-motd dest=/etc/motd owner=root group=root mode=0644

- hosts: client2
  sudo: yes
  tasks:
  - name: copy resolv.conf to the client
    copy: src=client-resolv.conf dest=/etc/resolv.conf owner=root group=root mode=0644
  - name: copy rndc conf file
    copy: src=rndc.conf dest=/home/vagrant/rndc.conf owner=vagrant group=vagrant mode=0644
  - name: copy motd to the client
    copy: src=client-motd dest=/etc/motd owner=root group=root mode=0644
